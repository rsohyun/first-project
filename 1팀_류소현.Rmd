---
title: "심혈관 질환에 대한 로짓회귀분석"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

# 요약
데이터 출처

분석 주제


본문

 - 필요한 패키지 불러오기
 
 - 데이터 불러오기
 
 - 전처리 하기
 
 - 로짓 회귀식 만들기, 이상치 검토, 모형 적합도
 파악하기
 
 - 모형간 적합도 비교하기
 
 - 모형별 predict 후 Accuracy 구하기
 
결론



# 데이터 출처 
https://www.kaggle.com/sulianova/cardiovascular-disease-dataset

# 분석주제

심혈관 질환은 다양한 원인에 의해 발생할 수 있다. 이 데이터에는 나이, 높이, 중량, 성별 뿐만 아니라 혈압, 콜레스테롤, 포도당, 흡연여부, 알코올 섭취, 신체활동 여부 등의 다양한 변수를 포함한다. 

그러므로 이 변수들을 활용하여 로짓회귀식을 만들고, 각각의 변수가 어떤 영향을 끼치는지, 또 예측할 수 있는 모형의 정확도는 어떠한지에 대해 분석해 보겠다. 

# 본문 

## 필요한 패키지 불러오기

```{r}
library(dplyr)
library(ggplot2)
library(readxl)
library(mlogit)
library(car)
library(ResourceSelection)
library(caret)
library(readr)
```

## 데이터 불러오기

```{r}
df <- read_delim("cardio_train.csv", delim = ";")
```

## 전처리 하기

```{r}
df <- df %>% relocate(cardio, .before = age)
df <- df %>% mutate(age = age/365) %>% round()
df$cardio <- as.factor(df$cardio)
df$gender <- as.factor(df$gender)
df$cholesterol <- as.factor(df$cholesterol)
df$gluc <- as.factor(df$gluc)
df$smoke <- as.factor(df$smoke)
df$alco <- as.factor(df$alco)
df$active <- as.factor(df$active)
str(df)
```

## 로짓 회귀식 만들기, 이상치 검토, 모형 적합도 파악하기

### 첫번째 로짓 회귀식(Logit_cardio2)

```{r}
Logit_cardio2 <- glm(cardio~ age+gender+weight, data = df, family = binomial())
```


#### 이상치 검토 (Logit_cardio2)
 
```{r}
outlierTest(Logit_cardio2)
```
NA없음

#### 모형 적합도 파악 (Logit_cardio2)

```{r}
hoslem.test(Logit_cardio2$y, Logit_cardio2$fit)
```
Logit_Buy2$fit가 0.05보다 작아 유의하지 않음
```{r}
summary(Logit_cardio2)
```
Null deviance: 97041 / Residual deviance:  90810 / dof: 69996

age가 많을수록 / gender가 낮을수록(1:여자일수록) / weight가 높을수록 (전부 p가 알파보다 작아 유의함)

### 두번째 로짓 회귀식(Logit_cardio3)

```{r}
Logit_cardio3 <- glm(cardio~ age+gender+weight+ap_hi+ap_lo, data = df, family = binomial())
```


#### 이상치 검토 (Logit_cardio3)
```{r}
outlierTest(Logit_cardio3) 
```
총 10개의 데이터에서 이상치발견

#### 모형 적합도 파악 (Logit_cardio3)
```{r}
hoslem.test(Logit_cardio3$y, Logit_cardio3$fit)
```
0.05보다 작아 유의하지 않음.

```{r}
summary(Logit_cardio3)
```
Null deviance = 97041 / residual deviance = 82351/ dof: 69994

age가 많을수록 / gender가 낮을수록(1:여자일수록) / weight가 높을수록/ap_hi(수축기 혈압)이 높을 수록 / ap_lo(이음증 혈압)이 높을수록 (전부 p가 알파보다 작아 유의함)


### 세번째 로짓 회귀식(Logit_cardio4)
```{r}
Logit_cardio4 <- glm(cardio~ age+gender+weight+ap_hi+ap_lo+cholesterol+active, data = df, family = binomial())
```


#### 이상치 검토 (Logit_cardio4)
```{r}
outlierTest(Logit_cardio4) 
```
총 10개의 데이터에서 이상치발견

#### 모형 적합도 파악 (Logit_cardio4)
```{r}
hoslem.test(Logit_cardio4$y, Logit_cardio4$fit)
```
0.05보다 작아 유의하지 않음.
```{r}
summary(Logit_cardio4)
```
Null deviance = 97041 / residual deviance = 81058/ dof: 69991

age가 많을수록 / gender가 낮을수록(1:여자일수록) / weight가 높을수록/ap_hi(수축기 혈압)이 높을 수록 / ap_lo(이음증 혈압)이 높을수록 / cholesteroz콜레스톨이 높을수록 / active운동을 안할수록 (전부 p가 알파보다 작아 유의함)


### 네번째 로짓 회귀식(Logit_cardio5)
```{r}
Logit_cardio5 <- glm(cardio~ age+gender+weight+ap_hi+ap_lo+cholesterol+active+smoke +alco, data = df, family = binomial())
```


#### 이상치 검토 (Logit_cardio5)
```{r}
outlierTest(Logit_cardio5) 
```
총 10개의 데이터에서 이상치발견

#### 모형 적합도 파악 (Logit_cardio5)
```{r}
hoslem.test(Logit_cardio5$y, Logit_cardio5$fit)
```
0.05보다 작아 유의하지 않음. 
```{r}
summary(Logit_cardio5)
```
Null deviance = 97041 / residual deviance = 81006/ dof: 69989

age가 많을수록 / gender가 낮을수록(1:여자일수록) / weight가 높을수록/ap_hi(수축기 혈압)이 높을 수록 / ap_lo(이음증 혈압)이 높을수록 / cholesteroz콜레스톨이 높을수록 / active운동을 안할수록 / smoke를 안할수록 / alco 술을 안마실수록 (전부 p가 알파보다 작아 유의함)

## 모형간 적합도 비교하기

### 첫번째와 두번째 비교(Logit_cardio2과 Logit_cardio3)

```{r}
Logit_cardio2$deviance-Logit_cardio3$deviance
diff <- Logit_cardio2$deviance-Logit_cardio3$deviance
```
deviance: -2LL 
```{r}
Logit_cardio2$df.residual-Logit_cardio3$df.residual 
dof <- Logit_cardio2$df.residual-Logit_cardio3$df.residual
```
자유도 residual차이

```{r}
pchisq(diff, dof)
1-pchisq(diff, dof)
```
cardio3가 0.05수준보다 작아 유의하므로 cardio2보다 더 좋은 모형이다.

### 두번째와 세번째 비교(Logit_cardio3과 Logit_cardio4)
```{r}
Logit_cardio3$deviance-Logit_cardio4$deviance
diff2 <- Logit_cardio3$deviance-Logit_cardio4$deviance

Logit_cardio3$df.residual-Logit_cardio4$df.residual 
dof2 <- Logit_cardio3$df.residual-Logit_cardio4$df.residual
```

```{r}
pchisq(diff2, dof2)
1-pchisq(diff2, dof2)
```
cardio4가 0.05수준보다 작아 유의하므로 cardio3보다 더 좋은 모형이다.


### 세번째와 네번째 비교(Logit_cardio4과 Logit_cardio5)
```{r}
Logit_cardio4$deviance-Logit_cardio5$deviance
diff3 <- Logit_cardio4$deviance-Logit_cardio5$deviance

Logit_cardio4$df.residual-Logit_cardio5$df.residual 
dof3 <- Logit_cardio4$df.residual-Logit_cardio5$df.residual
```

```{r}
pchisq(diff3, dof3)
1-pchisq(diff3, dof3)
```
cardio5가 0.05수준보다 작아 유의하므로 cardio4보다 더 좋은 모형이다.

## 모형별 predict 후 Accuracy 구하기

### 첫번째 모형
```{r}
prediction2 <- predict(Logit_cardio2, newdata = df)
prediction2 <- ifelse(prediction2 < 0, 0, 1)
prediction2 <- as.factor(prediction2)
confusionMatrix(prediction2, df$cardio)
```
Accuracy : 0.6219 / kappa: 0.2438

### 두번째 모형

```{r}
prediction3 <- predict(Logit_cardio3, newdata = df)
prediction3 <- ifelse(prediction3 < 0, 0, 1)
prediction3 <- as.factor(prediction3)
confusionMatrix(prediction3, df$cardio)
```
Accuracy : 0.7111  (증가함 but, accuracy은 0.8이상은 되어야함) 

### 세번째 모형
```{r}
prediction4 <- predict(Logit_cardio4, newdata = df)
prediction4 <- ifelse(prediction4 < 0, 0, 1)
prediction4 <- as.factor(prediction4)
confusionMatrix(prediction4, df$cardio)
```
Accuracy : 0.7204 , kappa: 0.4408 (증가함 but, accuracy은 0.8이상은 되어야함)


### 네번째 모형
```{r}
prediction5 <- predict(Logit_cardio5, newdata = df)
prediction5 <- ifelse(prediction5 < 0, 0, 1)
prediction5 <- as.factor(prediction5)
confusionMatrix(prediction5, df$cardio)
```
Accuracy :  0.7209 , kappa: 0.0.4417 (증가함 but, accuracy은 0.8이상은 되어야함) 


# 결론
총 네가지의 회귀모형식을 만들었다. 최종적으로 마지막에 만든 네번째 회귀식의 Accuracy와 kappa값이 가장 높았다. 
그러나 Accuracy :  0.7209 , kappa: 0.0.4417이므로 예측력이 매우 떨어진다.

네가지의 모든 모형식의 적합도에서 p-value값이 0.05보다 작아 유의하므로 "적합하지 않다"라는 결론이 나왔다.

네번째 회귀 모형식은 smoke(담배여부), alco(음주) 여부) 변수를 추가하였는데, 두 변수 모두 음수의 값이 나오므로 "심혈관 질환에 음의 영향을 지닌다"라고 할 수 있다. 하지만, 알려진 사실에 의하면 심혈관 질환을 예방하기 위해 담배와 음주는 꼭 끊어야 하는 것이다. 그러므로 데이터의 신뢰성을 의심해 보거나 모형을 알맞게 만들었는지 피드백이 필요할 것이다.  




